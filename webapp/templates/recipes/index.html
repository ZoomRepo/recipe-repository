{% extends "base.html" %}

{% block title %}
  {% if filters.query or filters.ingredients %}Filtered recipes{% else %}All recipes{% endif %}
{% endblock %}

{% block content %}
  {% set has_query = filters.query %}
  {% set has_ingredients = filters.ingredients %}
  {% if has_query and has_ingredients %}
    {% set heading = 'Recipes matching "' ~ filters.query ~ '" with ' ~ filters.ingredients|length ~ ' ingredient' ~ ('s' if filters.ingredients|length != 1 else '') %}
  {% elif has_query %}
    {% set heading = 'Recipes matching "' ~ filters.query ~ '"' %}
  {% elif has_ingredients %}
    {% set heading = 'Recipes containing ' ~ filters.ingredients|join(', ') %}
  {% else %}
    {% set heading = 'Latest recipes' %}
  {% endif %}
  {% set subtitle = results.total ~ ' recipe' ~ ('' if results.total == 1 else 's') ~ ' found' %}

  <div class="recipe-layout" data-role="search-layout">
    <aside class="filter-panel">
      <form
        id="filter-form"
        class="filter-form"
        action="{{ url_for('recipes.index') }}"
        method="get"
        data-endpoint="{{ url_for('recipes.api_recipes') }}"
      >
        <input type="hidden" name="page" value="{{ results.page }}">
        <details class="filter-section" open>
          <summary>Search</summary>
          <div class="filter-section-body">
            <label for="filter-query">Keyword</label>
            <input
              id="filter-query"
              name="q"
              type="search"
              placeholder="Search recipes..."
              value="{{ filters.query or '' }}"
            >
          </div>
        </details>
        <details class="filter-section" open>
          <summary>Ingredients</summary>
          <div class="filter-section-body">
            <label for="ingredient-field">Must include</label>
            <div class="ingredient-input" data-role="ingredient-input">
              <ul class="ingredient-chips" data-role="ingredient-chips">
                {% for ingredient in filters.ingredients %}
                  <li class="chip" data-value="{{ ingredient }}">
                    <span>{{ ingredient }}</span>
                    <button type="button" class="chip-remove" aria-label="Remove ingredient {{ ingredient }}">&times;</button>
                    <input type="hidden" name="ingredient" value="{{ ingredient }}">
                  </li>
                {% endfor %}
              </ul>
              <input
                id="ingredient-field"
                class="ingredient-field"
                type="text"
                placeholder="Add ingredient..."
                data-role="ingredient-field"
                autocomplete="off"
              >
              <p class="hint">Press Enter to add an ingredient filter.</p>
            </div>
          </div>
        </details>
        <div class="filter-actions">
          <button type="submit" class="filter-apply">Apply filters</button>
          <button type="button" class="filter-clear" data-role="clear-filters">Clear all</button>
        </div>
      </form>
    </aside>
    <section class="results-panel">
      <header class="results-header">
        <h1 data-role="results-title">{{ heading }}</h1>
        <p data-role="results-count">{{ subtitle }}</p>
      </header>
      <div data-role="results-container">
        {% include "recipes/_results.html" %}
      </div>
    </section>
  </div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script src="{{ url_for('static', filename='js/search.js') }}" defer></script>
{% endblock %}
